{% extends "base.html" %}
{% block title %}Inbox â€“ Archi Input{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Inbox</h1>
    <p class="page-subtitle">URLã‚‚ä½œå“åã‚‚ã€ã¾ã¨ã‚ã¦å…¥åŠ›ã™ã‚‹ã ã‘ã€‚AIãŒè‡ªå‹•ã§åˆ†æã—ã¾ã™</p>
</div>

{% if request.args.get('error') %}
<div class="alert alert-error">
    <span class="alert-icon">âš </span>
    {{ request.args.get('error') }}
</div>
{% endif %}

{% if request.args.get('success') %}
<div class="alert alert-success">
    <span class="alert-icon">âœ“</span>
    {% if request.args.get('bulk_count') %}
    {{ request.args.get('bulk_count') }}ä»¶ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼AIåˆ†æã‚’é–‹å§‹â€¦
    {% else %}
    è¿½åŠ ã—ã¾ã—ãŸï¼
    {% endif %}
    {% if request.args.get('analyzing') %}
    <span class="analyzing-indicator" id="auto-analyze-status" data-id="{{ request.args.get('analyzing') }}">
        <span class="spinner"></span> AIåˆ†æä¸­â€¦
    </span>
    {% endif %}
</div>
{% endif %}

<!-- ===== Smart Input (single field) ===== -->
<form action="{{ url_for('add_work') }}" method="POST" enctype="multipart/form-data" class="inbox-form">
    <div class="form-group">
        <label for="input">ğŸ” URLã¾ãŸã¯ä½œå“å</label>
        <input type="text" id="input" name="input" placeholder="URLã‚’ãƒšãƒ¼ã‚¹ãƒˆ or ä½œå“åã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šå…‰ã®æ•™ä¼šã€https://archdaily.com/...ï¼‰"
            class="form-input form-input-large" autocomplete="off" autofocus>
        <span class="form-hint">URLãªã‚‰ã‚¿ã‚¤ãƒˆãƒ«ã‚’è‡ªå‹•å–å¾—ã€ä½œå“åãªã‚‰AIãŒå»ºç¯‰æƒ…å ±ã‚’æ¨å®šã—ã¾ã™</span>
    </div>
    <div class="form-group">
        <label for="image">ğŸ“· å»ºç¯‰å†™çœŸï¼ˆä»»æ„ï¼‰</label>
        <div class="file-upload-wrapper">
            <input type="file" id="image" name="image" accept="image/*" class="file-input"
                onchange="previewImage(this)">
            <div class="file-upload-label" id="file-label">
                <span class="file-upload-icon">ğŸ“</span>
                <span>ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°ã§ç”»åƒã‚’é¸æŠ</span>
                <span class="file-upload-hint">PNG, JPG, WEBPï¼ˆ16MBã¾ã§ï¼‰</span>
            </div>
        </div>
        <div id="image-preview" class="image-preview" style="display:none;">
            <img id="preview-img" src="" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">
            <button type="button" class="btn btn-danger btn-sm" onclick="clearImage()">âœ• å‰Šé™¤</button>
        </div>
    </div>
    <button type="submit" class="btn btn-primary">
        <span class="btn-icon">+</span>
        è¿½åŠ 
    </button>
</form>

<!-- ===== Bulk Input (toggle) ===== -->
<div class="bulk-section">
    <button class="btn btn-ghost btn-sm" onclick="toggleBulk()">ğŸ“‹ ã¾ã¨ã‚ã¦è¿½åŠ ï¼ˆè¤‡æ•°URLãƒ»ä½œå“åï¼‰</button>
    <div id="bulk-panel" class="bulk-panel" style="display:none;">
        <form action="{{ url_for('bulk_add') }}" method="POST">
            <div class="form-group">
                <textarea name="bulk_input" class="form-input bulk-textarea"
                    placeholder="1è¡Œã«1ã¤ãšã¤URLã¾ãŸã¯ä½œå“åã‚’å…¥åŠ›ï¼ˆæœ€å¤§20ä»¶ï¼‰&#10;&#10;ä¾‹ï¼š&#10;https://archdaily.com/example1&#10;https://archdaily.com/example2&#10;å…‰ã®æ•™ä¼š&#10;ã‚µãƒ´ã‚©ã‚¢é‚¸"></textarea>
            </div>
            <button type="submit" class="btn btn-primary btn-sm">
                <span class="btn-icon">+</span>
                ã¾ã¨ã‚ã¦è¿½åŠ 
            </button>
        </form>
    </div>
</div>

<!-- ===== Bookmarklet ===== -->
<div class="bookmarklet-section">
    <h3 class="section-title">ğŸ“Œ ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ</h3>
    <p class="bookmarklet-desc">ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒãƒ¼ã«ãƒ‰ãƒ©ãƒƒã‚°ã™ã‚‹ã¨ã€è¦‹ã¦ã„ã‚‹ãƒšãƒ¼ã‚¸ã‚’ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ç™»éŒ²ã§ãã¾ã™</p>
    <div class="bookmarklet-container">
        <a class="bookmarklet-btn"
            href="javascript:void(window.open('http://163.44.119.69/quick_add?url='+encodeURIComponent(location.href)+'&title='+encodeURIComponent(document.title),'archi','width=400,height=300'))">
            ğŸ“Œ Archi Input ã«è¿½åŠ 
        </a>
        <span class="bookmarklet-hint">â† ã“ã®ãƒœã‚¿ãƒ³ã‚’ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒãƒ¼ã«ãƒ‰ãƒ©ãƒƒã‚°ï¼</span>
    </div>
</div>

{% if recent %}
<div class="recent-section">
    <h2 class="section-title">æœ€è¿‘ã®è¿½åŠ </h2>
    <div class="recent-list">
        {% for work in recent %}
        <div class="recent-item" id="recent-{{ work.id }}">
            <div class="recent-item-info">
                <div class="recent-item-top">
                    <span class="recent-title">{{ work.title or '(ç„¡é¡Œ)' }}</span>
                    {% if work.is_analyzed %}
                    <span class="badge badge-analyzed">åˆ†ææ¸ˆ</span>
                    {% endif %}
                </div>
                {% if work.url %}
                <a href="{{ work.url }}" target="_blank" rel="noopener" class="recent-url">{{ work.url[:60] }}{% if
                    work.url|length > 60 %}â€¦{% endif %}</a>
                {% endif %}
                {% if work.is_analyzed and work.architect %}
                <span class="recent-meta">{{ work.architect }}{% if work.year %} Â· {{ work.year }}{% endif %}{% if
                    work.country %} Â· {{ work.country }}{% endif %}</span>
                {% endif %}
            </div>
            <div class="recent-item-actions">
                {% if not work.is_analyzed %}
                <button class="btn btn-ai btn-sm" onclick="analyzeWork({{ work.id }}, this)" title="AIåˆ†æ">
                    ğŸ¤– åˆ†æ
                </button>
                {% endif %}
                <span class="recent-date">{{ work.created_at.strftime('%m/%d %H:%M') if work.created_at else ''
                    }}</span>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}
{% endblock %}