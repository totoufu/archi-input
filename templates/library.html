{% extends "base.html" %}
{% block title %}Library â€“ Archi Input{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Library</h1>
    <p class="page-subtitle">ç™»éŒ²æ¸ˆã¿ã®å»ºç¯‰äº‹ä¾‹ä¸€è¦§</p>
</div>

<form action="{{ url_for('library') }}" method="GET" class="search-form">
    <div class="search-wrapper">
        <span class="search-icon">ğŸ”</span>
        <input type="text" name="q" value="{{ query }}" placeholder="ä½œå“åãƒ»è¨­è¨ˆè€…ãƒ»å›½ãƒ»ç”¨é€”ã§æ¤œç´¢â€¦" class="search-input"
            autocomplete="off">
        {% if query %}
        <a href="{{ url_for('library') }}" class="search-clear" title="ã‚¯ãƒªã‚¢">âœ•</a>
        {% endif %}
    </div>
</form>

{% if works %}
<div class="library-stats">
    <span>{{ works|length }}ä»¶{% if query %} è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ{% endif %}</span>
</div>

<div class="library-list">
    {% for work in works %}
    <div class="library-item" id="lib-{{ work.id }}">
        <div class="library-item-main">
            <div class="library-item-info">
                <div class="library-title-row">
                    <span class="library-title">{{ work.title or '(ç„¡é¡Œ)' }}</span>
                    {% if work.is_analyzed %}
                    <span class="badge badge-analyzed">AIåˆ†ææ¸ˆ</span>
                    {% endif %}
                </div>
                {% if work.is_analyzed %}
                <div class="library-tags">
                    {% if work.architect %}<span class="tag tag-architect">{{ work.architect }}</span>{% endif %}
                    {% if work.year %}<span class="tag tag-year">{{ work.year }}</span>{% endif %}
                    {% if work.country %}<span class="tag tag-country">{{ work.country }}{% if work.city %} Â· {{
                        work.city }}{% endif %}</span>{% endif %}
                    {% if work.usage %}<span class="tag tag-usage">{{ work.usage }}</span>{% endif %}
                    {% if work.structure %}<span class="tag tag-structure">{{ work.structure }}</span>{% endif %}
                </div>
                {% if work.ai_description %}
                <p class="library-ai-desc">{{ work.ai_description }}</p>
                {% endif %}
                {% endif %}
                {% if work.url %}
                <a href="{{ work.url }}" target="_blank" rel="noopener" class="library-url">{{ work.url[:70] }}{% if
                    work.url|length > 70 %}â€¦{% endif %}</a>
                {% endif %}
            </div>
            <div class="library-item-meta">
                {% if work.is_reviewed %}
                <span class="badge badge-reviewed">ãƒ¬ãƒ“ãƒ¥ãƒ¼æ¸ˆ</span>
                {% else %}
                <span class="badge badge-new">æœªèª­</span>
                {% endif %}
                <span class="library-date">{{ work.created_at.strftime('%Y/%m/%d') if work.created_at else '' }}</span>
            </div>
        </div>
        <div class="library-item-notes">
            <textarea class="notes-input notes-small" placeholder="ãƒ¡ãƒ¢â€¦"
                data-id="{{ work.id }}">{{ work.notes }}</textarea>
            <div class="library-item-actions">
                <button class="btn btn-save btn-sm" onclick="saveNotes(this)" data-id="{{ work.id }}">ä¿å­˜</button>
                {% if work.is_analyzed %}
                <button class="btn btn-ai btn-sm" onclick="toggleDeepAnalysis({{ work.id }})">ğŸ’¬ æ·±æ˜ã‚Š</button>
                {% else %}
                <button class="btn btn-ai btn-sm" onclick="analyzeWork({{ work.id }}, this)">ğŸ¤– åˆ†æ</button>
                {% endif %}
                <form action="{{ url_for('delete_work', work_id=work.id) }}" method="POST" class="inline-form"
                    onsubmit="return confirm('ã“ã®ä½œå“ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')">
                    <button type="submit" class="btn btn-danger btn-sm">å‰Šé™¤</button>
                </form>
            </div>
        </div>
        <!-- Deep analysis panel -->
        <div class="deep-analysis-panel" id="deep-{{ work.id }}" style="display:none;">
            <div class="deep-input-row">
                <input type="text" class="form-input deep-prompt-input" id="deep-prompt-{{ work.id }}"
                    placeholder="ã“ã®ä½œå“ã«ã¤ã„ã¦è³ªå•ï¼ˆä¾‹ï¼šç©ºé–“æ§‹æˆã®ç‰¹å¾´ã¯ï¼Ÿä»–ã®æ•™ä¼šå»ºç¯‰ã¨ã®é•ã„ã¯ï¼Ÿï¼‰">
                <button class="btn btn-primary btn-sm" onclick="deepAnalyze({{ work.id }})">é€ä¿¡</button>
            </div>
            <div class="deep-output" id="deep-output-{{ work.id }}"></div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="empty-state">
    <div class="empty-icon">ğŸ“š</div>
    {% if query %}
    <p>ã€Œ{{ query }}ã€ã«ä¸€è‡´ã™ã‚‹ä½œå“ã¯ã‚ã‚Šã¾ã›ã‚“</p>
    {% else %}
    <p>ã¾ã ä½œå“ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
    <a href="{{ url_for('inbox') }}" class="btn btn-primary">Inboxã§è¿½åŠ ã™ã‚‹</a>
    {% endif %}
</div>
{% endif %}
{% endblock %}